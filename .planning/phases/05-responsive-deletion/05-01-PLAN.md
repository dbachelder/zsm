---
phase: 05-responsive-deletion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/session/manager.rs]
autonomous: true
---

<objective>
Add optimistic UI update when deleting sessions so the session disappears immediately rather than after MISSING_THRESHOLD (3) Zellij updates.

Purpose: Reduce perceived lag from ~3 event cycles to instant feedback when user confirms session deletion.
Output: SessionManager with immediate local removal on deletion confirmation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/session/manager.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add optimistic removal in confirm_deletion</name>
  <files>src/session/manager.rs</files>
  <action>
Modify `confirm_deletion()` to immediately remove the session from the local `sessions` vector (for existing sessions) or `resurrectable_sessions` vector (for resurrectable sessions) BEFORE calling `execute_action()`.

Implementation:
1. In `confirm_deletion()`, before taking `pending_deletion`:
   - Check if session_name exists in `self.sessions` - if so, retain all sessions except that name
   - Check if session_name exists in `self.resurrectable_sessions` - if so, retain all except that name
   - Also remove from `missing_counts` to clean up state
2. Then proceed with existing `execute_action()` call

This is an optimistic update - we remove locally first, then send the kill command to Zellij. If the kill fails for some reason, the session will reappear on the next SessionUpdate event, which is acceptable behavior.

Avoid: Don't change the stability tracking (MISSING_THRESHOLD) - it's still needed for other cases where sessions disappear temporarily.
  </action>
  <verify>cargo build --target wasm32-wasip1 succeeds</verify>
  <done>confirm_deletion removes session from local state before executing kill action</done>
</task>

<task type="auto">
  <name>Task 2: Add unit test for optimistic deletion</name>
  <files>src/session/manager.rs</files>
  <action>
Add a test to the existing test module that verifies the optimistic removal behavior:

```rust
#[test]
fn test_confirm_deletion_removes_session_immediately() {
    let mut manager = SessionManager::default();

    // Add sessions
    manager.update_sessions_stable(vec![
        make_session("keep", false),
        make_session("delete-me", false),
    ]);
    assert_eq!(manager.sessions().len(), 2);

    // Start and confirm deletion
    manager.start_deletion("delete-me".to_string());
    manager.confirm_deletion();

    // Session should be removed immediately (optimistic update)
    assert_eq!(manager.sessions().len(), 1);
    assert_eq!(manager.sessions()[0].name, "keep");
}
```

Also add a test for resurrectable session deletion:

```rust
#[test]
fn test_confirm_deletion_removes_resurrectable_immediately() {
    let mut manager = SessionManager::default();

    // Add resurrectable session
    manager.update_resurrectable_stable(vec![
        ("dead-session".to_string(), Duration::from_secs(60)),
    ]);
    assert_eq!(manager.resurrectable_sessions().len(), 1);

    // Start and confirm deletion
    manager.start_deletion("dead-session".to_string());
    manager.confirm_deletion();

    // Should be removed immediately
    assert_eq!(manager.resurrectable_sessions().len(), 0);
}
```
  </action>
  <verify>cargo test --target aarch64-apple-darwin passes (or appropriate native target)</verify>
  <done>Tests verify optimistic deletion for both existing and resurrectable sessions</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cargo build --target wasm32-wasip1` succeeds without errors
- [ ] `cargo test` passes all tests including new deletion tests
- [ ] No clippy warnings: `cargo clippy --target wasm32-wasip1 -- -D warnings`
</verification>

<success_criteria>
- confirm_deletion immediately removes session from local state
- Both existing sessions and resurrectable sessions are handled
- Unit tests verify the optimistic removal behavior
- Existing stability tracking remains unchanged for other use cases
</success_criteria>

<output>
After completion, create `.planning/phases/05-responsive-deletion/05-01-SUMMARY.md`
</output>
